<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>TIA - Tocantins Inteligência Artificial</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <nav>
      <a href="{{ url_for('chat') }}">Chat</a>
      <a href="{{ url_for('settings_model') }}">Configurações</a>
      <a href="{{ url_for('agents_list') }}">Agentes</a>
    </nav>
  </header>
  <main>
    <h1>Chat</h1>
    <form id="chat-form">
      <label>Destino</label>
      <select name="target">
        <option value="auto">Auto (Orquestrador)</option>
        {% for aid, title in agents %}
        <option value="{{ aid }}">{{ title }}</option>
        {% endfor %}
      </select>
      <label>Mensagem</label>
      <textarea name="message" rows="4" placeholder="Digite sua pergunta"></textarea>
      <button type="submit" id="send-btn">Enviar</button>
    </form>
    <div id="loading" class="spinner-container">
      <div class="spinner"></div>
      <span>Processando... Por favor, aguarde.</span>
    </div>
    <section id="reply"></section>
  </main>
  <script>
    document.getElementById('chat-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button');
      const replyDiv = document.getElementById('reply');
      const loadingDiv = document.getElementById('loading');
      
      btn.disabled = true;
      loadingDiv.style.display = 'flex';
      replyDiv.textContent = '';

      try {
        const data = new FormData(form);
        const r = await fetch('{{ url_for("api_chat") }}', { method:'POST', body: data });
        
        if (!r.ok) {
          const err = await r.json().catch(() => ({}));
          throw new Error(err.error || `Erro no servidor: ${r.status}`);
        }

        const j = await r.json();
        replyDiv.textContent = j.reply || '';
      } catch (err) {
        replyDiv.textContent = 'Erro: ' + err.message;
      } finally {
        btn.disabled = false;
        loadingDiv.style.display = 'none';
      }
    });
  </script>
</body>
</html>
